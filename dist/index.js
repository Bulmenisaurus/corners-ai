"use strict";(()=>{var P=(s,e)=>()=>(s&&(e=s(s=0)),e);var Z=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var A=(s,e,t)=>new Promise((o,n)=>{var r=a=>{try{i(t.next(a))}catch(l){n(l)}},c=a=>{try{i(t.throw(a))}catch(l){n(l)}},i=a=>a.done?o(a.value):Promise.resolve(a.value).then(r,c);i((t=t.apply(s,e)).next())});var N,E,T,L,b=P(()=>{"use strict";M();N=s=>{let e=n=>`${n.fromX},${n.fromY},${n.toX},${n.toY}`,t={};for(let n of s){let r=e(n);r in t?t[r].push(n):t[r]=[n]}let o=[];for(let n in t){let r=t[n].sort((c,i)=>c.fullMovePath.length-i.fullMovePath.length);o.push(r[0])}return o},E=(s,e,t)=>{let o=L(s,e,t,{fromX:s,fromY:e,toX:-1,toY:-1,fullMovePath:[[s,e]]},!1);return N(o)},T=s=>({fromX:s.fromX,fromY:s.fromY,fullMovePath:[...s.fullMovePath],toX:s.toX,toY:s.toY}),L=(s,e,t,o,n)=>{let r=[],c=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];for(let[i,a]of c){if(n)continue;let l=s+i,u=e+a;if(l>7||l<0||u>7||u<0||t.getPiece(l,u)!=m)continue;let f=T(o);f.fullMovePath.push([l,u]),f.toX=l,f.toY=u,r.push(f)}for(let[i,a]of c){let l=s+i*2,u=e+a*2;if(l>7||l<0||u>7||u<0)continue;let f=s+i,X=e+a,Y=t.getPiece(f,X)!=m,k=t.getPiece(l,u)==m,x=o.fullMovePath.some(([p,H])=>p==l&&H==u);if(!Y||!k||x)continue;let C=T(o);C.fullMovePath.push([l,u]);let D=L(l,u,t,C,!0);for(let p of D)r.push(p)}if(n){let i=T(o);i.toX=s,i.toY=e,r.push(i)}return r}});var B,I=P(()=>{"use strict";M();b();B=(s,e)=>{let t=s===d?0:7,o=s===d?7:0;return 1e3-e.coordinates().filter(([a,l])=>e.getPiece(a,l)===s).map(([a,l])=>Math.abs(a-t)+Math.abs(l-o)).reduce((a,l)=>a+l,0)}});var d,h,m,g,w,y,v,_,M=P(()=>{"use strict";I();b();d="black",h="white",m="none",g="black",w="white",y=class{constructor(e){this.pieces=e}getPiece(e,t){return this.pieces[e+t*8]}setPiece(e,t,o){this.pieces[e+t*8]=o}getTileColor(e,t){return[w,g][(e+t)%2]}coordinates(){let e=[];for(let t=0;t<8;t++)for(let o=0;o<8;o++)e.push([o,t]);return e}doMove(e){let t=this.getPiece(e.fromX,e.fromY);this.setPiece(e.fromX,e.fromY,m),this.setPiece(e.toX,e.toY,t)}undoMove(e){let t=this.getPiece(e.toX,e.toY);this.setPiece(e.fromX,e.fromY,t),this.setPiece(e.toX,e.toY,m)}},v=class{constructor(e,t,o){this.board=new y(Array(8*8).fill(m)),this.currentTurn="white",this.aiWorker=new Worker("./dist/worker.js"),this.boardElement=e,this.tilesElement=t,this.piecesElement=o,this.EZ_ENABLED=!1,this.EZ_TIMES=0,this.selectedTileCoordinates=void 0,e.addEventListener("click",n=>{this.onClick(n)}),this.aiWorker.onmessage=n=>{this.receiveAiMove(n.data)},this._initializeTileElements()}_initializeTileElements(){let e=this.board.coordinates().map(([t,o])=>{let n=document.createElement("div");return n.classList.add("tile"),n.classList.add(this.getTileColor(t,o)===g?"black":"white"),n.dataset.selected="false",n});this.tilesElement.append(...e)}loadFen(e){let t=e.split("/"),o=0,n=0;for(let r of t){for(let c of r)c==="P"?(this.setPiece(o,n,h),o++):c==="p"?(this.setPiece(o,n,d),o++):o+=parseInt(c);o=0,n+=1}}getTileElement(e,t){return Array.from(this.tilesElement.children)[e+t*8]}getPieceElement(e,t){return Array.from(this.piecesElement.children).find(r=>r.dataset.x===e.toString()&&r.dataset.y===t.toString())}setPiece(e,t,o){if(this.board.getPiece(e,t)===m){this.board.setPiece(e,t,o);let n=document.createElement("div");n.classList.add("piece"),n.dataset.pieceType=o,n.dataset.x=e.toString(),n.dataset.y=t.toString(),n.style.top=`calc(100%/8 * ${t} + (100%/8 - 10px) * 0.10)`,n.style.left=`calc(100%/8 * ${e} + (100%/8 - 10px) * 0.10)`,this.piecesElement.appendChild(n)}{let n=this.getPieceElement(e,t);n.dataset.pieceType=o}}uiAnimateMove(e){let{fromX:t,fromY:o,toX:n,toY:r}=e,c=this.getPieceElement(t,o);c.dataset.x=n.toString(),c.dataset.y=r.toString();let i=Math.min(1e3/(e.fullMovePath.length-1),500);c.style.transitionDuration=`${i}ms`;for(let a=1;a<e.fullMovePath.length;a++){let[l,u]=e.fullMovePath[a];window.setTimeout(()=>{c.style.top=`calc(100%/8 * ${u} + (100%/8 - 10px) * 0.10)`,c.style.left=`calc(100%/8 * ${l} + (100%/8 - 10px) * 0.10)`},i*(a-1))}c.style.zIndex="1",window.setTimeout(()=>{c.style.zIndex=""},i*e.fullMovePath.length)}select(e,t){let o=this.getTileElement(e,t);o.dataset.selected="true"}unselect(e,t){let o=this.getTileElement(e,t);o.dataset.selected="false"}getTileColor(e,t){return[w,g][(e+t)%2]}addSuggestions(e,t){let o=E(e,t,this.board);for(let n of o)this.getTileElement(n.toX,n.toY).classList.add("valid")}clearSuggestions(){Array.from(document.querySelectorAll(".valid")).map(e=>e.classList.remove("valid"))}onClick(e){let t=e.offsetX,o=e.offsetY,n=t/this.boardElement.getBoundingClientRect().width,r=o/this.boardElement.getBoundingClientRect().height,c=Math.floor(n*8),i=Math.floor(r*8);this.onTileClick(c,i)}onTileClick(e,t){let o=this.selectedTileCoordinates;if(this.EZ_onTileClick(e,t),o!==void 0)this.unselect(o[0],o[1]),this.selectedTileCoordinates=void 0,this.tryMove(o[0],o[1],e,t);else{if(this.board.getPiece(e,t)===m)return;this.selectedTileCoordinates=[e,t],this.select(e,t)}}removeMarks(){Array.from(document.querySelectorAll(".mark")).map(e=>e.classList.remove("mark"))}markMove(e){e.fullMovePath.forEach(([t,o])=>{this.getTileElement(t,o).classList.add("mark")})}initiateAiMove(){this.aiWorker.postMessage([this.board.pieces,this.currentTurn,this.EZ_ENABLED])}receiveAiMove(e){this.currentTurn=this.currentTurn===d?h:d,e===void 0?console.warn("AI has no response, probably end of game?"):(this.doMove(e),this.markMove(e))}doMove(e){this.board.setPiece(e.toX,e.toY,this.board.getPiece(e.fromX,e.fromY)),this.board.setPiece(e.fromX,e.fromY,m),this.uiAnimateMove(e),this.removeMarks()}undoMove(e){let t=this.board.getPiece(e.toX,e.toY);this.setPiece(e.fromX,e.fromY,t),this.setPiece(e.toX,e.toY,m)}tryMove(e,t,o,n){if(this.board.getPiece(e,t)!==this.currentTurn||e===o&&t==n)return;let c=E(e,t,this.board).find(i=>i.toX===o&&i.toY===n);if(c===void 0){new Audio("./audio/wood-sound-error.mp3").play();return}this.doMove(c),console.log(`My score: ${B(h,this.board)}`),this.currentTurn=this.currentTurn===d?h:d,window.setTimeout(()=>{this.initiateAiMove()},1e3)}EZ_onTileClick(e,t){this.EZ_TIMES+=e+t?-this.EZ_TIMES:1,this.EZ_ENABLED||(this.EZ_ENABLED=this.EZ_TIMES>2),this.EZ_ENABLED&&this.EZ_playAnimation()}EZ_playAnimation(){this.getTileElement(0,0).style.transform="rotate(360deg)"}},_=(s,e)=>{e.append(s.tilesElement,s.piecesElement)}});var K=Z(S=>{M();var $=s=>A(S,null,function*(){let e=document.createElement("div");e.id="board-container",s.appendChild(e);let t=document.createElement("div");t.id="tiles";let o=document.createElement("div");o.id="pieces";let n=new v(e,t,o);n.loadFen("4pppp/5ppp/6pp/7p/P/PP/PPP/PPPP"),_(n,e)});window.addEventListener("load",()=>{let s=document.getElementsByTagName("main")[0];$(s)})});K();})();
