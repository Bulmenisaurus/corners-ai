"use strict";(()=>{var g=(s,e)=>()=>(s&&(e=s(s=0)),e);var _=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var C=(s,e,t)=>new Promise((o,n)=>{var r=a=>{try{i(t.next(a))}catch(c){n(c)}},l=a=>{try{i(t.throw(a))}catch(c){n(c)}},i=a=>a.done?o(a.value):Promise.resolve(a.value).then(r,l);i((t=t.apply(s,e)).next())});var D,p,E,L,I=g(()=>{"use strict";v();D=s=>{let e=n=>`${n.fromX},${n.fromY},${n.toX},${n.toY}`,t={};for(let n of s){let r=e(n);r in t?t[r].push(n):t[r]=[n]}let o=[];for(let n in t){let r=t[n].sort((l,i)=>l.fullMovePath.length-i.fullMovePath.length);o.push(r[0])}return o},p=(s,e,t)=>{let o=L(s,e,t,{fromX:s,fromY:e,toX:-1,toY:-1,fullMovePath:[[s,e]]},!1);return D(o)},E=s=>({fromX:s.fromX,fromY:s.fromY,fullMovePath:[...s.fullMovePath],toX:s.toX,toY:s.toY}),L=(s,e,t,o,n)=>{let r=[],l=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];for(let[i,a]of l){if(n)continue;let c=s+i,d=e+a;if(c>7||c<0||d>7||d<0||t.getPiece(c,d)!=u)continue;let m=E(o);m.fullMovePath.push([c,d]),m.toX=c,m.toY=d,r.push(m)}for(let[i,a]of l){let c=s+i*2,d=e+a*2;if(c>7||c<0||d>7||d<0)continue;let m=s+i,k=e+a,A=t.getPiece(m,k)!=u,X=t.getPiece(c,d)==u,H=o.fullMovePath.some(([M,S])=>M==c&&S==d);if(!A||!X||H)continue;let b=E(o);b.fullMovePath.push([c,d]);let x=L(c,d,t,b,!0);for(let M of x)r.push(M)}if(n){let i=E(o);i.toX=s,i.toY=e,r.push(i)}return r}});var f,T,u,P,B,y,h,w,v=g(()=>{"use strict";I();f="black",T="white",u="none",P="black",B="white",y=class{constructor(e){this.pieces=e}getPiece(e,t){return this.pieces[e+t*8]}setPiece(e,t,o){this.pieces[e+t*8]=o}getTileColor(e,t){return[B,P][(e+t)%2]}coordinates(){let e=[];for(let t=0;t<8;t++)for(let o=0;o<8;o++)e.push([o,t]);return e}doMove(e){let t=this.getPiece(e.fromX,e.fromY);this.setPiece(e.fromX,e.fromY,u),this.setPiece(e.toX,e.toY,t)}undoMove(e){let t=this.getPiece(e.toX,e.toY);this.setPiece(e.fromX,e.fromY,t),this.setPiece(e.toX,e.toY,u)}},h=class{constructor(e,t,o){this.board=new y(Array(8*8).fill(u)),this.currentTurn="white",this.aiWorker=new Worker("./dist/worker.js"),this.boardElement=e,this.tilesElement=t,this.piecesElement=o,this.difficulty="easy",this.selectedTileCoordinates=void 0,e.addEventListener("click",n=>{this.onClick(n)}),this.aiWorker.onmessage=n=>{this.receiveAiMove(n.data)},this._initializeTileElements()}_initializeTileElements(){let e=this.board.coordinates().map(([t,o])=>{let n=document.createElement("div");return n.classList.add("tile"),n.classList.add(this.getTileColor(t,o)===P?"black":"white"),n.dataset.selected="false",n});this.tilesElement.append(...e)}loadFen(e){let t=e.split("/"),o=0,n=0;for(let r of t){for(let l of r)l==="P"?(this.setPiece(o,n,T),o++):l==="p"?(this.setPiece(o,n,f),o++):o+=parseInt(l);o=0,n+=1}}getTileElement(e,t){return Array.from(this.tilesElement.children)[e+t*8]}getPieceElement(e,t){return Array.from(this.piecesElement.children).find(r=>r.dataset.x===e.toString()&&r.dataset.y===t.toString())}setPiece(e,t,o){if(this.board.getPiece(e,t)===u){this.board.setPiece(e,t,o);let n=document.createElement("div");n.classList.add("piece"),n.dataset.pieceType=o,n.dataset.x=e.toString(),n.dataset.y=t.toString(),n.style.top=`calc(100%/8 * ${t} + (100%/8 - 10px) * 0.10)`,n.style.left=`calc(100%/8 * ${e} + (100%/8 - 10px) * 0.10)`,this.piecesElement.appendChild(n)}{let n=this.getPieceElement(e,t);n.dataset.pieceType=o}}uiAnimateMove(e){let{fromX:t,fromY:o,toX:n,toY:r}=e,l=this.getPieceElement(t,o);l.dataset.x=n.toString(),l.dataset.y=r.toString();let i=Math.min(1e3/(e.fullMovePath.length-1),500);l.style.transitionDuration=`${i}ms`;for(let a=1;a<e.fullMovePath.length;a++){let[c,d]=e.fullMovePath[a];window.setTimeout(()=>{l.style.top=`calc(100%/8 * ${d} + (100%/8 - 10px) * 0.10)`,l.style.left=`calc(100%/8 * ${c} + (100%/8 - 10px) * 0.10)`},i*(a-1))}l.style.zIndex="1",window.setTimeout(()=>{l.style.zIndex=""},i*e.fullMovePath.length)}select(e,t){let o=this.getTileElement(e,t);o.dataset.selected="true"}unselect(e,t){let o=this.getTileElement(e,t);o.dataset.selected="false"}getTileColor(e,t){return[B,P][(e+t)%2]}addSuggestions(e,t){let o=p(e,t,this.board);for(let n of o)this.getTileElement(n.toX,n.toY).classList.add("valid")}clearSuggestions(){Array.from(document.querySelectorAll(".valid")).map(e=>e.classList.remove("valid"))}onClick(e){let t=e.offsetX,o=e.offsetY,n=t/this.boardElement.getBoundingClientRect().width,r=o/this.boardElement.getBoundingClientRect().height,l=Math.floor(n*8),i=Math.floor(r*8);this.onTileClick(l,i)}onTileClick(e,t){let o=this.selectedTileCoordinates;if(o!==void 0)this.unselect(o[0],o[1]),this.selectedTileCoordinates=void 0,this.tryMove(o[0],o[1],e,t);else{if(this.board.getPiece(e,t)===u)return;this.selectedTileCoordinates=[e,t],this.select(e,t)}}removeMarks(){Array.from(document.querySelectorAll(".mark")).map(e=>e.classList.remove("mark"))}markMove(e){e.fullMovePath.forEach(([t,o])=>{this.getTileElement(t,o).classList.add("mark")})}initiateAiMove(){this.aiWorker.postMessage([this.board.pieces,this.currentTurn,this.difficulty])}receiveAiMove(e){this.currentTurn=this.currentTurn===f?T:f,e===void 0?console.warn("AI has no response, probably end of game?"):(this.doMove(e),this.markMove(e))}doMove(e){this.board.setPiece(e.toX,e.toY,this.board.getPiece(e.fromX,e.fromY)),this.board.setPiece(e.fromX,e.fromY,u),this.uiAnimateMove(e),this.removeMarks()}undoMove(e){let t=this.board.getPiece(e.toX,e.toY);this.setPiece(e.fromX,e.fromY,t),this.setPiece(e.toX,e.toY,u)}tryMove(e,t,o,n){if(this.board.getPiece(e,t)!==this.currentTurn||e===o&&t==n)return;let l=p(e,t,this.board).find(i=>i.toX===o&&i.toY===n);if(l===void 0){new Audio("./audio/wood-sound-error.mp3").play();return}this.doMove(l),this.currentTurn=this.currentTurn===f?T:f,window.setTimeout(()=>{this.initiateAiMove()},1e3)}},w=(s,e)=>{e.append(s.tilesElement,s.piecesElement)}});var K=_(Y=>{v();var W=s=>C(Y,null,function*(){let e=document.createElement("div");e.id="board-container",s.appendChild(e);let t=document.createElement("div");t.id="tiles";let o=document.createElement("div");o.id="pieces";let n=new h(e,t,o);n.loadFen("4pppp/5ppp/6pp/7p/P/PP/PPP/PPPP"),w(n,e);let r=document.getElementById("easy"),l=document.getElementById("medium"),i=document.getElementById("hard");r.onclick=()=>{r.dataset.selected="true",l.dataset.selected=i.dataset.selected="false",n.difficulty="easy",localStorage.setItem("difficulty","easy")},l.onclick=()=>{l.dataset.selected="true",r.dataset.selected=i.dataset.selected="false",n.difficulty="medium",localStorage.setItem("difficulty","medium")},i.onclick=()=>{i.dataset.selected="true",r.dataset.selected=l.dataset.selected="false",n.difficulty="hard",localStorage.setItem("difficulty","hard")};let a={easy:r,medium:l,hard:i},c=localStorage.getItem("difficulty");(c==="easy"||c==="medium"||c==="hard")&&(n.difficulty=c,a[c].dataset.selected="true")});window.addEventListener("load",()=>{let s=document.getElementsByTagName("main")[0];W(s)})});K();})();
